<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Luxibre Alpha - Signaux Boursiers</title>
<style>
  /* Reset minimal */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background: #121212;
    color: #eee;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: #1e1e1e;
    padding: 1rem 2rem;
    font-size: 1.5rem;
    font-weight: 700;
    border-bottom: 2px solid #4caf50;
    text-align: center;
  }
  main {
    flex: 1;
    padding: 1rem 2rem;
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  thead {
    background-color: #333;
  }
  th, td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #444;
  }
  th {
    color: #4caf50;
  }
  tr:nth-child(even) {
    background-color: #1a1a1a;
  }
  .signal-name {
    font-weight: 700;
    font-size: 1.1rem;
  }
  .signal-type {
    font-style: italic;
    color: #a0a0a0;
  }
  /* Premium signal highlight */
  .premium {
    background-color: #263238;
    border-left: 5px solid #ffab00;
  }
  /* Signal status color */
  .signal-buy {
    color: #4caf50;
    font-weight: 700;
  }
  .signal-sell {
    color: #f44336;
    font-weight: 700;
  }
  .signal-hold {
    color: #ffeb3b;
    font-weight: 700;
  }
  /* Graph container */
  .chart-container {
    width: 150px;
    height: 70px;
  }
  /* Responsive tweaks */
  @media (max-width: 800px) {
    th, td {
      padding: 0.5rem 0.5rem;
      font-size: 0.9rem;
    }
    .chart-container {
      width: 100px;
      height: 50px;
    }
  }
  /* Error message styling */
  #error-message {
    margin-top: 2rem;
    color: #f44336;
    font-weight: 700;
    font-size: 1.2rem;
    text-align: center;
  }
</style>
</head>
<body>

<header>Luxibre Alpha - Dashboard des Signaux Boursiers</header>

<main>
  <div id="error-message" role="alert" aria-live="assertive" style="display:none;"></div>

  <table aria-describedby="desc-signaux" aria-live="polite" role="table" id="signals-table">
    <caption id="desc-signaux" style="text-align:left; font-weight:bold; margin-bottom:0.5rem;">
      Liste des signaux boursiers avec mini-graphique de tendance
    </caption>
    <thead>
      <tr>
        <th scope="col">Actif</th>
        <th scope="col">Type</th>
        <th scope="col">Signal</th>
        <th scope="col">Cours (€)</th>
        <th scope="col">Tendance (7j)</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rempli dynamiquement -->
    </tbody>
  </table>
</main>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // Fonction utilitaire pour formater les nombres avec 2 décimales
  function formatPrice(price) {
    return price ? price.toFixed(2) : "-";
  }

  // Map status à couleur / classe CSS
  const signalClassMap = {
    'buy': 'signal-buy',
    'sell': 'signal-sell',
    'hold': 'signal-hold'
  };

  // Fonction pour créer un mini-graph avec Chart.js dans un canvas donné
  function createMiniChart(canvas, dataPoints) {
    if (!dataPoints || dataPoints.length === 0) {
      // Rien à afficher
      return;
    }
    new Chart(canvas, {
      type: 'line',
      data: {
        labels: dataPoints.map((_, i) => i + 1),
        datasets: [{
          data: dataPoints,
          borderColor: '#4caf50',
          backgroundColor: 'rgba(76,175,80,0.2)',
          tension: 0.3,
          fill: true,
          pointRadius: 0
        }]
      },
      options: {
        animation: false,
        responsive: false,
        maintainAspectRatio: false,
        scales: {
          x: { display: false },
          y: { display: false }
        },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        elements: {
          line: { borderWidth: 2 }
        }
      }
    });
  }

  async function loadSignals() {
    const tbody = document.querySelector("#signals-table tbody");
    const errorDiv = document.getElementById("error-message");

    try {
      const response = await fetch("data/signals.json", {cache: "no-store"});
      if (!response.ok) throw new Error(`HTTP error ${response.status}`);
      const signals = await response.json();

      // Vider le tableau si déjà rempli
      tbody.innerHTML = "";

      if (!Array.isArray(signals) || signals.length === 0) {
        errorDiv.textContent = "Aucun signal disponible pour le moment.";
        errorDiv.style.display = "block";
        return;
      } else {
        errorDiv.style.display = "none";
      }

      // Boucle sur chaque signal pour créer une ligne
      signals.forEach((signal, index) => {
        const tr = document.createElement("tr");
        if (signal.isPremium) tr.classList.add("premium");

        // Col 1: Nom actif
        const tdName = document.createElement("td");
        tdName.textContent = signal.name || "-";
        tdName.classList.add("signal-name");
        tr.appendChild(tdName);

        // Col 2: Type d'actif
        const tdType = document.createElement("td");
        tdType.textContent = signal.type || "-";
        tdType.classList.add("signal-type");
        tr.appendChild(tdType);

        // Col 3: Signal (Buy / Sell / Hold)
        const tdSignal = document.createElement("td");
        const signalStatus = (signal.signal || "").toLowerCase();
        tdSignal.textContent = signal.signal || "-";
        if (signalClassMap[signalStatus]) tdSignal.classList.add(signalClassMap[signalStatus]);
        tr.appendChild(tdSignal);

        // Col 4: Cours actuel
        const tdPrice = document.createElement("td");
        tdPrice.textContent = formatPrice(signal.price);
        tr.appendChild(tdPrice);

        // Col 5: Mini-graph tendance 7 jours
        const tdChart = document.createElement("td");
        const chartContainer = document.createElement("div");
        chartContainer.classList.add("chart-container");
        const canvas = document.createElement("canvas");
        canvas.width = 150;
        canvas.height = 70;
        chartContainer.appendChild(canvas);
        tdChart.appendChild(chartContainer);
        tr.appendChild(tdChart);

        tbody.appendChild(tr);

        // Créer le mini-graph
        createMiniChart(canvas, signal.trend7d);
      });

    } catch (error) {
      errorDiv.textContent = "Erreur lors du chargement des signaux : " + error.message;
      errorDiv.style.display = "block";
      tbody.innerHTML = "";
      console.error(error);
    }
  }

  // Lancement au chargement de la page
  window.addEventListener("DOMContentLoaded", () => {
    loadSignals();
  });
</script>

</body>
</html>
